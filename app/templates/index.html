{% extends "base.html" %}
{% block content %}
<h2>Datos del paciente</h2>
<form method="post">
<div class="row g-3">
  <div class="col-md-6">
    <label class="form-label">Nombre</label>
    <input class="form-control" name="nombre" placeholder="Nombre"/>
  </div>
  <div class="col-md-6">
    <label class="form-label">Apellidos</label>
    <input class="form-control" name="apellidos" placeholder="Apellidos"/>
  </div>
  <div class="col-md-4">
    <label class="form-label">Nº Historia Clínica</label>
    <input class="form-control" name="historia" placeholder="HC-001"/>
  </div>
  <div class="col-md-4">
    <label class="form-label">Sexo</label>
    <select class="form-select" name="sexo">
      <option>-</option><option>F</option><option>M</option><option>Otro</option>
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">Fecha de nacimiento</label>
    <input class="form-control" name="fecha_nac" placeholder="dd/mm/yyyy"/>
  </div>
</div>

<hr/>
<h2>Datos clínicos</h2>
<div class="row g-3">
  <div class="col-md-6">
    <label class="form-label">
      Enfermedad actual <span class="help" data-bs-toggle="tooltip" title="Diagnóstico principal que motiva el tratamiento.">?</span>
    </label>
    <input class="form-control" name="enf_actual" placeholder="Patología principal"/>
  </div>
  <div class="col-md-6">
    <label class="form-label">
      Otras patologías <span class="help" data-bs-toggle="tooltip" title="Comorbilidades relevantes separadas por comas.">?</span>
    </label>
    <input class="form-control" name="otras_pat" placeholder="Separadas por comas"/>
  </div>
  <div class="col-md-12">
    <label class="form-label">
      Tratamiento <span class="help" data-bs-toggle="tooltip" title="Fármacos actuales o propuestos, separados por comas.">?</span>
    </label>
    <input class="form-control" name="tto" placeholder="Fármacos separados por comas"/>
  </div>
</div>

<hr/>
<h2>Datos genéticos</h2>

<!-- === DPYD === -->
<div class="row mt-2">
  <div class="col-12">
    <h5>DPYD
      <span class="help" data-bs-toggle="tooltip" title="Elige modo: diplotipo por estrellas o genotipos por SNP.">?</span>
    </h5>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="dpyd_mode" id="dpyd_mark" value="markers" checked>
      <label class="form-check-label" for="dpyd_mark">Por marcadores</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="dpyd_mode" id="dpyd_dipl" value="diplotype">
      <label class="form-check-label" for="dpyd_dipl">Diplotipo (rápido)</label>
    </div>
  </div>

  <!-- Marcadores -->
  <div id="dpyd_markers_section" class="col-12 mt-2">
    <div class="row g-3">
      {% for col, options in dpyd_inputs.items() %}
      <div class="col-md-3">
        <label class="form-label">{{ col }}</label>
        <select class="form-select" name="{{ col }}">
          {% for op in options %}<option>{{ op }}</option>{% endfor %}
        </select>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Diplotipo -->
  <div id="dpyd_diplotype_section" class="col-12 mt-2 d-none">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Alelo 1</label>
        <select class="form-select" name="dpyd_a1">
          {% for s in dpyd_stars %}<option>{{ s }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Alelo 2</label>
        <select class="form-select" name="dpyd_a2">
          {% for s in dpyd_stars %}<option>{{ s }}</option>{% endfor %}
        </select>
      </div>
    </div>
  </div>
</div>

<!-- === UGT1A1 === -->
<div class="row mt-4">
  <div class="col-12">
    <h5>UGT1A1
      <span class="help" data-bs-toggle="tooltip" title="Diplotipo (*1/*28) o genotipo del tag *80 (C/C, C/T, T/T).">?</span>
    </h5>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="ugt_mode" id="ugt_mark" value="markers" checked>
      <label class="form-check-label" for="ugt_mark">Por marcadores</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="ugt_mode" id="ugt_dipl" value="diplotype">
      <label class="form-check-label" for="ugt_dipl">Diplotipo (rápido)</label>
    </div>
  </div>

  <!-- Marcadores -->
  <div id="ugt_markers_section" class="col-12 mt-2">
    <div class="row g-3">
      {% for col, options in ugt_inputs.items() %}
      <div class="col-md-3">
        <label class="form-label">{{ col }}</label>
        <select class="form-select" name="{{ col }}">
          {% for op in options %}<option>{{ op }}</option>{% endfor %}
        </select>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Diplotipo -->
  <div id="ugt_diplotype_section" class="col-12 mt-2 d-none">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Alelo 1</label>
        <select class="form-select" name="ugt_a1">
          {% for s in ugt_stars %}<option>{{ s }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Alelo 2</label>
        <select class="form-select" name="ugt_a2">
          {% for s in ugt_stars %}<option>{{ s }}</option>{% endfor %}
        </select>
      </div>
    </div>
  </div>
</div>

<!-- === CYP2D6 === -->
<div class="row mt-4">
  <div class="col-12">
    <h5>CYP2D6
      <span class="help" data-bs-toggle="tooltip" title="‘Diplotipo’ es la notación clínica estándar (p. ej., *1/*4). ‘Por marcadores’ introduce SNPs.">?</span>
    </h5>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="cyp_mode" id="mode_dipl" value="diplotype" checked>
      <label class="form-check-label" for="mode_dipl">Diplotipo (rápido)</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="cyp_mode" id="mode_mark" value="markers">
      <label class="form-check-label" for="mode_mark">Por marcadores (detallado)</label>
    </div>
  </div>

  <!-- Diplotipo -->
  <div id="cyp_diplotype_section" class="col-md-6 mt-2">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Alelo 1</label>
        <select class="form-select" name="cyp_a1">
          {% for s in cyp_stars %}<option>{{ s }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Alelo 2</label>
        <select class="form-select" name="cyp_a2">
          {% for s in cyp_stars %}<option>{{ s }}</option>{% endfor %}
        </select>
      </div>
    </div>
  </div>

  <!-- Marcadores -->
  <div id="cyp_markers_section" class="col-12 mt-3 d-none">
    <div class="card p-3">
      <div class="mb-2"><strong>Entrada por marcadores CYP2D6</strong></div>
      <div class="row g-3">
        {% for m in cyp_inputs %}
          <div class="col-md-3">
            <label class="form-label">{{ m[0] }}</label>
            <select class="form-select" name="{{ m[0] }}">
              {% for op in m[1] %}<option>{{ op }}</option>{% endfor %}
            </select>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<div class="mt-4">
  <button class="btn btn-primary">Vista previa</button>
</div>
</form>

<!-- Conmutadores mostrar/ocultar -->
<script>
  function toggleBlock(group){
    const modeMarkers = document.getElementById(group + '_mark');
    const secMarkers  = document.getElementById(group + '_markers_section');
    const secDipl     = document.getElementById(group + '_diplotype_section');
    if(!modeMarkers || !secMarkers || !secDipl) return;
    const isMarkers = modeMarkers.checked;
    secMarkers.classList.toggle('d-none', !isMarkers);
    secDipl.classList.toggle('d-none', isMarkers);
  }

  // DPYD
  document.getElementById('dpyd_mark').addEventListener('change', () => toggleBlock('dpyd'));
  document.getElementById('dpyd_dipl').addEventListener('change', () => toggleBlock('dpyd'));
  toggleBlock('dpyd');

  // UGT1A1
  document.getElementById('ugt_mark').addEventListener('change', () => toggleBlock('ugt'));
  document.getElementById('ugt_dipl').addEventListener('change', () => toggleBlock('ugt'));
  toggleBlock('ugt');

  // CYP2D6
  const radioDipl = document.getElementById('mode_dipl');
  const radioMark = document.getElementById('mode_mark');
  const secDipl   = document.getElementById('cyp_diplotype_section');
  const secMark   = document.getElementById('cyp_markers_section');
  function toggleCYP() {
    if (radioDipl.checked) { secDipl.classList.remove('d-none'); secMark.classList.add('d-none'); }
    else { secDipl.classList.add('d-none'); secMark.classList.remove('d-none'); }
  }
  radioDipl.addEventListener('change', toggleCYP);
  radioMark.addEventListener('change', toggleCYP);
  toggleCYP();
</script>
{% endblock %}
